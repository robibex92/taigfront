import axios from 'axios';
import { LIST_TELEGRAM_CHATS } from '../config/telegramChats';
import { announcementApi } from '../api/announcementApi';

const TELEGRAM_API_URL = process.env.REACT_APP_API_URL;
const SERVER_SALT = process.env.REACT_APP_SERVER_SALT;

const api = axios.create({
  baseURL: TELEGRAM_API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Utility function to escape Markdown V2 special characters
function escapeMarkdownV2(text) {
  if (!text || typeof text !== 'string') return '';

  return text
    .replace(/\\/g, '\\\\')  // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ñ‹Ðµ ÑÐ»ÑÑˆÐ¸
    .replace(/([_*[\]()~`>#+\-={}|.!])/g, '\\$1')  // Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ ÑÐ¿ÐµÑ†ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Markdown
    .replace(/\n/g, '\\n')   // Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÑ‹ ÑÑ‚Ñ€Ð¾Ðº
    .trim();  // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð»Ð¸ÑˆÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð¸ ÐºÐ¾Ð½Ñ†Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
}

function formatTelegramMessage(post) {
  const markerPrefix = post.marker === 'critical' ? 'ðŸš¨ *Ð’ÐÐ–ÐÐžÐ•* ðŸš¨' :
                       post.marker === 'marketing' ? 'ðŸ“£ *Ð ÐµÐºÐ»Ð°Ð¼Ð°*' :
                       'ðŸ“';

  const title = escapeMarkdownV2(post.title || '');
  const content = escapeMarkdownV2(post.content || '');

  return `${markerPrefix}\nðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸\n${title}\nðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸ðŸ”¸\n${content}`;
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸ Ð² Telegram
export const sendPostToTelegram = async (post) => {
  // Validate post input
  if (!post || !post.id) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚', post);
    return { success: false, error: 'Invalid post data' };
  }

  // Validate post_id
  const postId = Number(post.id);
  if (isNaN(postId)) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ°: post_id Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ñ‡Ð¸ÑÐ»Ð¾Ð¼', post.id);
    return { success: false, error: 'ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ post_id' };
  }

  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð» Ð»Ð¸ Ð¿Ð¾ÑÑ‚ ÑƒÐ¶Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½
    const existingMessages = await announcementApi.getTelegramMessages(postId);

    if (existingMessages && existingMessages.length > 0) {
      console.warn(`ÐŸÐ¾ÑÑ‚ ${postId} ÑƒÐ¶Ðµ Ð±Ñ‹Ð» Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ñ€Ð°Ð½ÐµÐµ`);
      return { success: false, error: 'Message already sent' };
    }

    const botToken = process.env.REACT_APP_TELEGRAM_BOT_TOKEN;
  
    // Validate bot token
    if (!botToken) {
      return { success: false, error: 'Missing bot token' };
    }

    // Validate chat list
    if (!Array.isArray(LIST_TELEGRAM_CHATS.NEWS_UPDATE) || LIST_TELEGRAM_CHATS.NEWS_UPDATE.length === 0) {
      return { success: false, error: 'No chats available' };
    }

    // Prepare message text with markdown escaping
    const messageText = formatTelegramMessage(post);

    // Enhance image URL to prevent caching issues
    const enhancedImageUrl = post.image_url 
      ? `${post.image_url}?v=${Date.now()}` 
      : null;

    // Send promises for ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°
    const sendPromises = LIST_TELEGRAM_CHATS.NEWS_UPDATE.map(async (chat, index) => {
      try {
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸
        if (index > 0) {
          await delay(1000); 
        }

        // Determine API endpoint and body based on image availability
        const telegramApiUrl = `https://api.telegram.org/bot${botToken}/${enhancedImageUrl ? 'sendPhoto' : 'sendMessage'}`;
        
        // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
        const body = {
          chat_id: chat.id,
          parse_mode: 'MarkdownV2',
          ...(chat.threadId && { message_thread_id: chat.threadId }) // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ threadId, ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ
        };

        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
        if (enhancedImageUrl) {
          body.photo = enhancedImageUrl;
          body.caption = messageText;
        } else {
          body.text = messageText;
        }

        const response = await fetch(telegramApiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();

        if (!result.ok) {
          console.error(`Telegram API Error for chat ${chat.id}:`, result);
          throw new Error(`Telegram API Error: ${JSON.stringify(result)}`);
        }

        const messageId = result.result.message_id; 

        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ thread_id
        await updateMessageIdInDatabase(postId, messageId, chat);

        return result;
      } catch (error) {
        console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð² Ñ‡Ð°Ñ‚ ${chat.id}:`, error);
        return null;
      }
    });

    // Use Promise.allSettled to handle individual promise failures
    const results = await Promise.allSettled(sendPromises);

    // Check overall success
    const successfulResults = results.filter(result => result.status === 'fulfilled' && result.value !== null);
    const failedResults = results.filter(result => result.status === 'rejected' || result.value === null);

    return {
      success: successfulResults.length > 0,
      successCount: successfulResults.length,
      failedCount: failedResults.length,
      error: failedResults.length > 0 ? 'ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð½Ðµ Ð±Ñ‹Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹' : null
    };

  } catch (error) {
    console.error('ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¿Ð¾ÑÑ‚Ð°:', error);
    return { 
      success: false, 
      error: error.message || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¿Ð¾ÑÑ‚Ð°' 
    };
  }
};

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ message_id Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const updateMessageIdInDatabase = async (postId, messageId, chat) => {
  try {
    await announcementApi.createTelegramMessage({
      chat_id: chat.id,
      message_id: messageId,
      post_id: postId,
      thread_id: chat.threadId || null,
      created_at: new Date().toISOString()
    });
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
  }
};

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÑÑ‚Ð° Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð½Ð° "inactive"
export const deleteInactivePostMessages = async (postId) => {
  try {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾ÑÑ‚Ðµ
    const post = await announcementApi.getAnnouncement(postId);

    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ð²ÑÐµÑ… Ñ‡Ð°Ñ‚Ð¾Ð² NEWS_UPDATE
    const deletePromises = LIST_TELEGRAM_CHATS.NEWS_UPDATE.map(async (chat) => {
      try {
        const response = await fetch(`https://api.telegram.org/bot${process.env.REACT_APP_TELEGRAM_BOT_TOKEN}/deleteMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: chat.id,
            message_id: post.message_id 
          })
        });

        return await response.json();
      } catch (error) {
        return null;
      }
    });

    // ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²ÑÐµÑ… ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¹
    const results = await Promise.all(deletePromises);

    return {
      success: results.every(result => result && result.ok),
      results
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
};

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

export const sendNewsToTelegram = async (news) => {
  try {
    const response = await api.post('/telegram/news', {
      ...news,
      salt: SERVER_SALT
    });
    return response.data;
  } catch (error) {
    console.error('Error sending news to Telegram:', error);
    throw error;
  }
};

export const sendUpdateToTelegram = async (update) => {
  try {
    const response = await api.post('/telegram/update', {
      ...update,
      salt: SERVER_SALT
    });
    return response.data;
  } catch (error) {
    console.error('Error sending update to Telegram:', error);
    throw error;
  }
};

export default {
  sendNewsToTelegram,
  sendUpdateToTelegram
};
